<!DOCTYPE html>
<html lang="zh-CN">
<!-- Generated by AI -->

<head>
  <meta charset="UTF-8">
  <title>LlamaIndex & TiDB RAG Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/marked@0.3.6"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
</head>

<body>
  <div id="app" class="flex justify-around p-10 min-h-screen">
    <div class="w-1/2">
      <div class="flex justify-between">
        <label class="block w-4/5">
          <input type="text" v-model="question" placeholder="Input question..."
            class="p-2 w-full border-solid border-gray-600 focus:border-gray-900 border rounded-none focus:outline-none">
        </label>
        <button type="button" class="bg-black ml-2 w-1/5 p-2 rounded	text-white" :disabled="loading"
          @click="askQuestion">
          <i v-if="loading && answer == ''" class="fas fa-spinner animate-spin"></i>
          Ask
        </button>
      </div>
      <div id="answer" class="w-full min-h-max border py-2 px-6 mt-6 bg-slate-100">
        <h1 class="text-center">Answer Body</h1>
        <hr class="my-2" />
        <div v-html="compiledMarkdown">Empty</div>
      </div>
    </div>
    <div class="w-1/2 ml-4 border p-2 bg-slate-100 min-h-fit">
      <h1 class="text-center">Chunks Retrieved</h1>
      <hr class="my-2" />
      <ul v-for="node in source_nodes" class="list-decimal ml-4">
        <li class="pl-4" v-text="node.node.text"></li>
      </ul>
    </div>
  </div>
  <script>
    new Vue({
      el: '#app',
      data: {
        question: 'What did the author do at each stage of his/her growth? Use markdown format if possible',
        answer: 'Empty...',
        requestID: '',
        loading: false,
        source_nodes: [],
      },
      computed: {
        compiledMarkdown: function () {
          return marked(this.answer, { sanitize: true });
        }
      },
      filters: {
        pretty: function (value) {
          return JSON.stringify(JSON.parse(value), null, 2);
        }
      },
      methods: {
        askQuestion: function () {
          const self = this;
          if (this.question.trim() === '') {
            alert('Please input a question.');
            return;
          }
          self.source_nodes = [];
          self.answer = '';
          self.loading = true;
          fetch(`/ask?q=${encodeURIComponent(this.question)}`)
            .then(response => {
              const reader = response.body.getReader();
              const stream = new ReadableStream({
                start(controller) {
                  function push() {
                    reader.read().then(({ done, value }) => {
                      if (done) {
                        controller.close();
                        self.loading = false;
                        return;
                      }
                      const chunkValue = new TextDecoder("utf-8").decode(value);
                      chunkValue
                        .split('\n\n')
                        .forEach(chunk => {
                          if (chunk.startsWith('1: ')) {
                            const meta = chunk.substring(3);
                            self.source_nodes = JSON.parse(chunk.replace('1: ', ''));
                          } else {
                            const data = chunk.replace('2: ', '');
                            if (data) {
                              self.answer += data;
                            }
                          }
                        });
                      controller.enqueue(value);
                      push();
                    }).catch(error => {
                      self.loading = false;
                      console.error('Fetch error:', error);
                      controller.error(error);
                    });
                  }
                  push();
                }
              });
              self.requestID = response.headers.get('X-Request-ID');
              return new Response(stream);
            })
            .catch(error => {
              console.error('Fetch error:', error);
              self.loading = false;
              alert('An error occurred while fetching the response.');
            });
        }
      }
    });
  </script>
</body>

</html>